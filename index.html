<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Average Calculator - Formatted</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f8fafc;
            --border: #e2e8f0;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-top: 0; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #475569; }
        input { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        input:focus { outline: none; border-color: var(--primary); }
        
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; margin-top: 10px; }
        button:hover { background: #1d4ed8; }

        .results { margin-top: 30px; display: none; }
        .card { padding: 20px; border-radius: 12px; margin-bottom: 15px; background: #f8fafc; border: 1px solid var(--border); }
        .card-title { font-weight: bold; border-bottom: 1px solid var(--border); margin-bottom: 10px; padding-bottom: 5px; color: var(--primary); }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .val { font-weight: 700; }
        .profit { color: var(--success); }
        .loss { color: var(--danger); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 10px; border: 1px solid var(--border); text-align: left; }
        th { background: #f1f5f9; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“ˆ Stock Average Calc</h2>
    
    <div class="grid">
        <div class="input-group full-width">
            <label>Stock Code / Name</label>
            <input type="text" id="symbol" placeholder="e.g. BBCA">
        </div>
        <div class="input-group">
            <label>Current Avg Price</label>
            <input type="text" id="currAvg" class="number-input" placeholder="0">
        </div>
        <div class="input-group">
            <label>Current Total Lot</label>
            <input type="text" id="currLot" class="number-input" placeholder="0">
        </div>
        <div class="input-group">
            <label>Last Market Price</label>
            <input type="text" id="marketPrice" class="number-input" placeholder="0">
        </div>
        <div class="input-group">
            <label>Budget for New Purchase</label>
            <input type="text" id="budget" class="number-input" placeholder="0">
        </div>
    </div>

    <button onclick="calculate()">Calculate New Position</button>

    <div id="results" class="results">
        <div class="card">
            <div class="card-title">Purchase Analysis for <span id="resSymbol">-</span></div>
            <div class="row">Lots you can buy: <span id="newLots" class="val">-</span></div>
            <div class="row">Shares you can buy: <span id="newShares" class="val">-</span></div>
            <div class="row">Total Cost for this buy: <span id="buyCost" class="val">-</span></div>
        </div>

        <div class="card">
            <div class="card-title">Comparison Summary</div>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Current</th>
                        <th>After Purchase</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Avg Price</td>
                        <td id="tableOldAvg">-</td>
                        <td id="tableNewAvg" class="val">-</td>
                    </tr>
                    <tr>
                        <td>Total Lots</td>
                        <td id="tableOldLots">-</td>
                        <td id="tableNewLots">-</td>
                    </tr>
                    <tr>
                        <td>Gain/Loss Amt</td>
                        <td id="tableOldGL">-</td>
                        <td id="tableNewGL">-</td>
                    </tr>
                    <tr>
                        <td>Gain/Loss %</td>
                        <td id="tableOldPerc">-</td>
                        <td id="tableNewPerc">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 1. Function to format input as user types
    document.querySelectorAll('.number-input').forEach(input => {
        input.addEventListener('input', function(e) {
            // Remove everything except numbers
            let value = this.value.replace(/,/g, '');
            if (!isNaN(value) && value !== "") {
                this.value = parseFloat(value).toLocaleString('en-US');
            } else {
                this.value = "";
            }
        });
    });

    // Helper to get clean numeric value from formatted input
    function getCleanValue(id) {
        let val = document.getElementById(id).value.replace(/,/g, '');
        return parseFloat(val) || 0;
    }

    function calculate() {
        const symbol = document.getElementById('symbol').value || "Stock";
        const currAvg = getCleanValue('currAvg');
        const currLot = getCleanValue('currLot');
        const marketPrice = getCleanValue('marketPrice');
        const budget = getCleanValue('budget');

        if (currAvg <= 0 || marketPrice <= 0) {
            alert("Please enter valid prices.");
            return;
        }

        // Logic
        const oldShares = currLot * 100;
        const lotsToBuy = Math.floor((budget / marketPrice) / 100);
        const sharesToBuy = lotsToBuy * 100;
        const actualSpend = sharesToBuy * marketPrice;

        const oldTotalCost = oldShares * currAvg;
        const oldMarketVal = oldShares * marketPrice;
        const oldGL = oldMarketVal - oldTotalCost;
        const oldPerc = oldTotalCost > 0 ? (oldGL / oldTotalCost) * 100 : 0;

        const totalSharesNew = oldShares + sharesToBuy;
        const totalCostNew = oldTotalCost + actualSpend;
        const newAvgPrice = totalSharesNew > 0 ? totalCostNew / totalSharesNew : 0;
        const newMarketVal = totalSharesNew * marketPrice;
        const newGL = newMarketVal - totalCostNew;
        const newPerc = totalCostNew > 0 ? (newGL / totalCostNew) * 100 : 0;

        // Display
        document.getElementById('results').style.display = 'block';
        document.getElementById('resSymbol').innerText = symbol.toUpperCase();
        document.getElementById('newLots').innerText = lotsToBuy.toLocaleString();
        document.getElementById('newShares').innerText = sharesToBuy.toLocaleString();
        document.getElementById('buyCost').innerText = actualSpend.toLocaleString();

        document.getElementById('tableOldAvg').innerText = currAvg.toLocaleString();
        // Specifically adding thousand separator to the New Avg result
        document.getElementById('tableNewAvg').innerText = newAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        document.getElementById('tableOldLots').innerText = currLot.toLocaleString();
        document.getElementById('tableNewLots').innerText = (currLot + lotsToBuy).toLocaleString();

        formatTableCell('tableOldGL', oldGL);
        formatTableCell('tableOldPerc', oldPerc.toFixed(2) + "%", oldGL);
        formatTableCell('tableNewGL', newGL);
        formatTableCell('tableNewPerc', newPerc.toFixed(2) + "%", newGL);
    }

    function formatTableCell(id, value, compareVal = null) {
        const el = document.getElementById(id);
        const check = compareVal !== null ? compareVal : value;
        el.innerText = typeof value === 'number' ? value.toLocaleString() : value;
        el.className = check >= 0 ? 'profit' : 'loss';
        if (check >= 0 && typeof value === 'number') el.innerText = "+" + el.innerText;
    }
</script>

</body>
</html>
